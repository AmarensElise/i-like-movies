<div class=" rounded-xl p-6 mb-8">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">What People Like About This Movie</h2>



  <!-- Display Top 10 Likes -->
  <% movie_likes = movie.movie_likes
      .includes(:user, :movie_like_votes)
      .select('movie_likes.*, COUNT(movie_like_votes.id) as votes_count_cache')
      .left_joins(:movie_like_votes)
      .group('movie_likes.id')
      .order('votes_count_cache DESC, movie_likes.created_at DESC')
      .limit(10) %>
  
  <% if movie_likes.any? %>
    <div class="flex flex-wrap gap-2 justify-center">
      <% movie_likes.each do |like| %>
        <div class="group relative" data-controller="toggle">
          <button
            type="button"
            data-action="toggle#toggle"
            data-toggle-target="button"
            class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-sm text-gray-800 transition cursor-pointer">
            <span><%= like.content %></span>
            <span class="flex items-center gap-1 text-xs text-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-3 w-3">
                <path d="M1 8.25a1.25 1.25 0 1 1 2.5 0v7.5a1.25 1.25 0 1 1-2.5 0v-7.5ZM11 3V1.7c0-.268.14-.526.395-.607A2 2 0 0 1 14 3c0 .995-.182 1.948-.514 2.826-.204.54.166 1.174.744 1.174h2.52c1.243 0 2.261 1.01 2.146 2.247a23.864 23.864 0 0 1-1.341 5.974C17.153 16.323 16.072 17 14.9 17h-3.192a3 3 0 0 1-1.341-.317l-2.734-1.366A3 3 0 0 0 6.292 15H5V8h.963c.685 0 1.258-.483 1.612-1.068a4.011 4.011 0 0 1 2.166-1.73c.432-.143.853-.386 1.011-.814.16-.432.248-.9.248-1.388Z" />
              </svg>
              <%= like.try(:votes_count_cache) || like.votes_count %>
            </span>
          </button>

          <!-- Hover/Click Details Panel -->
          <div data-toggle-target="panel" class="hidden absolute z-10 mt-2 w-72 bg-white rounded-lg shadow-xl border border-gray-200 p-4 left-0">
            <p class="text-gray-800 mb-3 font-medium"><%= like.content %></p>
            
            <div class="flex items-center gap-3 text-xs text-gray-600 mb-3">
              <span class="flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-3 w-3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg>
                <%= like.user.email.split('@').first %>
              </span>
              <span class="text-gray-400">â€¢</span>
              <span><%= time_ago_in_words(like.created_at) %> ago</span>
            </div>

            <div class="flex items-center gap-2">
              <!-- Vote Button -->
              <% if user_signed_in? %>
                <% if like.voted_by?(current_user) %>
                  <% vote = like.movie_like_votes.find_by(user: current_user) %>
                  <%= button_to movie_like_vote_path(vote), 
                      method: :delete,
                      class: "flex items-center gap-1 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-xs font-medium hover:bg-blue-200 transition" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                      <path d="M1 8.25a1.25 1.25 0 1 1 2.5 0v7.5a1.25 1.25 0 1 1-2.5 0v-7.5ZM11 3V1.7c0-.268.14-.526.395-.607A2 2 0 0 1 14 3c0 .995-.182 1.948-.514 2.826-.204.54.166 1.174.744 1.174h2.52c1.243 0 2.261 1.01 2.146 2.247a23.864 23.864 0 0 1-1.341 5.974C17.153 16.323 16.072 17 14.9 17h-3.192a3 3 0 0 1-1.341-.317l-2.734-1.366A3 3 0 0 0 6.292 15H5V8h.963c.685 0 1.258-.483 1.612-1.068a4.011 4.011 0 0 1 2.166-1.73c.432-.143.853-.386 1.011-.814.16-.432.248-.9.248-1.388Z" />
                    </svg>
                    Agreed (<%= like.try(:votes_count_cache) || like.votes_count %>)
                  <% end %>
                <% else %>
                  <%= button_to movie_like_votes_path(movie_like_id: like.id), 
                      method: :post,
                      class: "flex items-center gap-1 px-3 py-1.5 bg-gray-200 text-gray-700 rounded-full text-xs font-medium hover:bg-gray-300 transition" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6.633 10.5c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V3a.75.75 0 0 1 .75-.75A2.25 2.25 0 0 1 16.5 4.5c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H14.23c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H6.75a.75.75 0 0 1-.75-.75v-9Z" />
                    </svg>
                    Agree (<%= like.try(:votes_count_cache) || like.votes_count %>)
                  <% end %>
                <% end %>

                <!-- Delete Button (only for own likes) -->
                <% if like.user == current_user %>
                  <%= button_to movie_like_path(like), 
                      method: :delete, 
                      data: { turbo_confirm: "Delete this?" },
                      class: "text-red-600 hover:text-red-800 p-1" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                  <% end %>
                <% end %>
              <% else %>
                <span class="flex items-center gap-1 px-3 py-1.5 bg-gray-200 text-gray-700 rounded-full text-xs">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="m15 11.25-3-3m0 0-3 3m3-3v7.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>

                  <%= like.try(:votes_count_cache) || like.votes_count %>
                </span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-8 text-gray-500">
      <p class="text-sm">No one has shared what they like yet. Be the first!</p>
    </div>
<% end %>

    <!-- Add New Like Form - Always Visible -->
<% if user_signed_in? %>
    <div class="flex justify-center max-w-xl items-center mt-6 mx-auto">
        <%= form_with model: MovieLike.new, url: movie_likes_path(movie_id: movie.id), class: "flex gap-2 w-full" do |f| %>
            <%= f.text_field :content, 
                    placeholder: "What do you like? (e.g., 'Amazing soundtrack', 'Perfect pacing'...)",
                    class: "flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" %>
            <%= f.submit "Share", class: "bg-blue-600 text-white font-medium py-2 px-3 rounded-full hover:bg-blue-100 hover:text-blue-800 transition cursor-pointer text-sm" %>
        <% end %>
    </div>
<% end %>
</div>
