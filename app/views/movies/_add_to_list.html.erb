<% if user_signed_in? %>
  <div data-controller="toggle" class="mt-3">
    <button
      type="button"
      data-action="toggle#toggle"
      data-toggle-target="button"
      class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm font-medium transition bg-gray-100 hover:bg-gray-200 text-gray-700 cursor-pointer"
      title="Add to list">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      <span data-toggle-target="label">Add to List</span>
    </button>

    <div data-toggle-target="panel" class="hidden mt-3 w-full">
      <div class="bg-gray-50 rounded-lg p-4 max-w-md">
        <% if current_user.lists.any? %>
          <h3 class="font-semibold text-gray-900 mb-3">Select a list:</h3>
          <div class="space-y-2 max-h-64 overflow-y-auto">
            <% current_user.lists.order(name: :asc).each do |list| %>
              <% movie_in_list = list.list_items.exists?(movie_id: movie.id) %>
              <div class="flex items-center justify-between p-2 bg-white rounded hover:bg-gray-100">
                <div class="flex items-center gap-2">
                  <% if movie_in_list %>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5 text-green-600">
                      <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
                    </svg>
                  <% else %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-gray-400">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                  <% end %>
                  <span class="text-sm font-medium text-gray-900"><%= list.name %></span>
                  <span class="text-xs text-gray-500">(<%= list.movies.count %>)</span>
                </div>
                <% if movie_in_list %>
                  <% list_item = list.list_items.find_by(movie_id: movie.id) %>
                  <%= button_to list_item_path(list_item), method: :delete, data: { turbo: false }, class: "text-xs text-red-600 hover:text-red-800 font-medium" do %>
                    Remove
                  <% end %>
                <% else %>
                  <%= button_to list_items_path(list_id: list.id, movie_id: movie.id), method: :post, data: { turbo: false }, class: "text-xs text-blue-600 hover:text-blue-800 font-medium" do %>
                    Add
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
          <div class="mt-3 pt-3 border-t border-gray-200">
            <%= link_to new_list_path, class: "text-sm text-blue-600 hover:text-blue-800 font-medium" do %>
              + Create New List
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-600 mb-3">You don't have any lists yet.</p>
          <%= link_to new_list_path, class: "inline-flex items-center gap-2 rounded-full bg-blue-600 px-4 py-2 text-sm font-medium text-white transition hover:bg-blue-700" do %>
            Create Your First List
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
